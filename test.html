<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ªæ–‡æ›¸ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fontsã‚’èª­ã¿è¾¼ã¿ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1:wght@700&family=Yusei+Magic&family=Zen+Maru+Gothic:wght@900&family=Mochiy+Pop+One&family=Kosugi+Maru&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #1a202c; /* ãƒ€ãƒ¼ã‚¯ãªèƒŒæ™¯ï¼ˆé»’ã«è¿‘ã„ï¼‰ã«æˆ»ã™ */
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 1rem;
    }
    
    .paper-container {
      border: none;
      transform: rotate(0);
      filter: none;
      /* èƒŒæ™¯ã‚’é€éã›ãšã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯è‰²ã§å¡—ã‚Šã¤ã¶ã™ */
      background-color: transparent;
    }

    #generator-canvas {
      /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯CSSã§è¨­å®š */
      background-color: #fff8e1; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯ã‚’ã‚¯ãƒªãƒ¼ãƒ è‰²ã«å¤‰æ›´ */
    }

    .btn-style {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
    }
    .btn-style:hover {
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    .btn-style:active {
      transform: translateY(1px);
    }
    
  </style>
</head>
<body class="font-sans">
  <div class="container mx-auto max-w-2xl bg-gray-800 rounded-xl shadow-2xl p-6 md:p-10 text-center space-y-6">
    <h1 class="text-3xl font-extrabold text-white tracking-tight">
      æ€ªæ–‡æ›¸ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
    </h1>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ (Canvas) -->
    <div id="canvas-container" class="relative w-full flex justify-center items-center rounded-lg overflow-hidden shadow-inner paper-container">
      <canvas id="generator-canvas" width="600" height="400"></canvas>
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="space-y-4">
      <div>
        <label for="upperText" class="block text-left text-sm font-bold text-gray-300 mb-1">ä¸Šæ®µã®ãƒ†ã‚­ã‚¹ãƒˆ</label>
        <input type="text" id="upperText" value="æ˜æ—¥ã€æ­£åˆ" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg">
      </div>
      <div>
        <label for="lowerText" class="block text-left text-sm font-bold text-gray-300 mb-1">ä¸‹æ®µã®ãƒ†ã‚­ã‚¹ãƒˆ</label>
        <input type="text" id="lowerText" value="æ¸¯ã®å€‰åº«ã«æ¥ã„" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg">
      </div>
    </div>
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆé¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
    <div class="space-y-2 mt-4 text-left">
      <span class="text-sm font-bold text-gray-300">ä½¿ç”¨ã™ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„:</span>
      <div id="font-checkboxes" class="flex flex-wrap gap-4 mt-2">
        <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>

    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center">
        <!-- è¦‹ãŸç›®ã‚’å†ç”Ÿæˆãƒœã‚¿ãƒ³ -->
        <button id="regenerate-appearance-button" class="w-full sm:w-auto px-8 py-4 bg-yellow-400 text-black font-bold text-xl rounded-lg btn-style focus:outline-none focus:ring-4 focus:ring-yellow-400 focus:ring-opacity-50">
            ğŸ¨ è¦‹ãŸç›®ã‚’å†ç”Ÿæˆ
        </button>
        <!-- ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³ -->
        <button id="save-button" class="w-full sm:w-auto px-8 py-4 bg-red-600 text-white font-bold text-xl rounded-lg btn-style focus:outline-none focus:ring-4 focus:ring-red-600 focus:ring-opacity-50">
            ç”»åƒã‚’ä¿å­˜
        </button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('generator-canvas');
      const ctx = canvas.getContext('2d');
      const upperTextInput = document.getElementById('upperText');
      const lowerTextInput = document.getElementById('lowerText');
      const saveButton = document.getElementById('save-button');
      const regenerateAppearanceButton = document.getElementById('regenerate-appearance-button');
      const fontCheckboxesContainer = document.getElementById('font-checkboxes');
      
      // ä½¿ç”¨ã™ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã®é…åˆ—ã‚’å®šç¾©
      const allFonts = [
        { name: 'Shippori Mincho B1', weight: '700', size: 70, label: 'æ˜æœ' },
        { name: 'Yusei Magic', weight: 'normal', size: 68, label: 'å„ªé›…' },
        { name: 'Zen Maru Gothic', weight: '900', size: 75, label: 'ä¸¸å­—' },
        { name: 'Mochiy Pop One', weight: 'normal', size: 70, label: 'ãƒãƒƒãƒ—' },
        { name: 'Kosugi Maru', weight: 'normal', size: 72, label: 'ã‚´ã‚·ãƒƒã‚¯' }
      ];

      // æ–‡å­—ã®èƒŒæ™¯è‰²ã«ä½¿ç”¨ã™ã‚‹ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’å®šç¾©ï¼ˆèµ¤è‰²ã‚’é™¤ãï¼‰
      const backgroundColors = [
        '#FFFFFF', // ç™½
        '#E0E0E0', // è–„ã„ç°è‰²
        '#CCCCCC', // ç°è‰²
        '#000000', // é»’
      ];

      // å„æ–‡å­—ã®èƒŒæ™¯è‰²ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
      let fixedColorsUpper = null;
      let fixedColorsLower = null;
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å‹•çš„ã«ç”Ÿæˆ
      allFonts.forEach((font, index) => {
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'flex items-center';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `font-checkbox-${index}`;
        checkbox.className = 'form-checkbox h-5 w-5 text-purple-600';
        checkbox.checked = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã™ã¹ã¦é¸æŠ
        
        const label = document.createElement('label');
        label.htmlFor = `font-checkbox-${index}`;
        label.className = 'ml-2 text-white cursor-pointer';
        label.textContent = font.label;
        label.style.fontFamily = `'${font.name}', sans-serif`;
        
        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(label);
        fontCheckboxesContainer.appendChild(checkboxDiv);
        
        checkbox.addEventListener('change', () => {
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ãŒã‚ã£ãŸã‚‰ã€ãƒ•ã‚©ãƒ³ãƒˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†æç”»
          drawCanvas();
        });
      });

      // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
      const getSelectedFonts = () => {
        const selectedFonts = [];
        const checkboxes = fontCheckboxesContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach((checkbox, index) => {
          if (checkbox.checked) {
            selectedFonts.push(allFonts[index]);
          }
        });
        // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ³ãƒˆãŒ1ã¤ã‚‚ãªã„å ´åˆã¯ã€å…¨ã¦ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨
        return selectedFonts.length > 0 ? selectedFonts : allFonts;
      };

      // å®šç¾©ã•ã‚ŒãŸãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚’å–å¾—ã™ã‚‹é–¢æ•°
      const getBackgroundColor = (avoidColor = null) => {
        let newColor;
        do {
          const randomIndex = Math.floor(Math.random() * backgroundColors.length);
          newColor = backgroundColors[randomIndex];
        } while (newColor === avoidColor); // é¿ã‘ã‚‹ã¹ãè‰²ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
        return newColor;
      };
      
      // Canvasã«è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æç”»ã™ã‚‹é–¢æ•°
      const drawWarning = (message) => {
        ctx.fillStyle = '#fff8e1';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#FF0000'; // èµ¤è‰²
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
      };

      // ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»ã™ã‚‹å…±é€šé–¢æ•°
      const drawText = (text, yPos, bgColors) => {
        if (!text) return;
        
        const maxWidth = canvas.width - 60; // å·¦å³ã®ä½™ç™½ã‚’è€ƒæ…®
        const regularPadding = 8; // é€šå¸¸ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        const smallCharPadding = 1; // å¥èª­ç‚¹ãªã©ã®å°ã•ã„æ–‡å­—ç”¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        const spacing = 10; // æ–‡å­—é–“ã®éš™é–“
        const selectedFonts = getSelectedFonts();
        const spaceWidth = 20; // ã‚¹ãƒšãƒ¼ã‚¹ã®å¹…ã‚’å®šç¾©
        
        let charData = []; // å„æ–‡å­—ã®æç”»ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        let totalTextWidth = 0;
        let fontSizeMultiplier = 1;
        
        // å°ã•ã„æ–‡å­—ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
        const isSmallCharacter = (char) => {
          return ['ã€', 'ã€‚', 'ï¼', 'ï¼Ÿ', 'ãƒ»'].includes(char);
        };

        // --- ç¬¬1æ®µéš: å„æ–‡å­—ã®æç”»ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã€åˆè¨ˆå¹…ã‚’è¨ˆç®—ã™ã‚‹ ---
        text.split('').forEach((char, index) => {
          if (char === ' ' || char === 'ã€€') { // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚‚è¿½åŠ 
            charData.push({ isSpace: true, width: spaceWidth });
            totalTextWidth += spaceWidth + spacing;
          } else {
            const font = selectedFonts[index % selectedFonts.length];
            
            const padding = isSmallCharacter(char) ? smallCharPadding : regularPadding;
            const bgColor = bgColors[index];
            const size = font.size;
            ctx.font = `${font.weight} ${size}px "${font.name}"`;
            const textMetrics = ctx.measureText(char);
            const textWidth = textMetrics.width;
            const bgWidth = textWidth + padding * 2;
            const bgHeight = size + padding * 2;
            charData.push({ char, font, size, textWidth, bgWidth, bgColor, isSpace: false, width: bgWidth, bgHeight });
            totalTextWidth += bgWidth + spacing;
          }
        });
        
        // æœ€å¾Œã®æ–‡å­—ã®éš™é–“ã¯è€ƒæ…®ã—ãªã„
        if (charData.length > 0) {
            totalTextWidth -= spacing;
        }

        // å…¨ä½“ã®å¹…ãŒCanvasã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã€ç¸®å°ç‡ã‚’è¨ˆç®—
        if (totalTextWidth > maxWidth) {
          fontSizeMultiplier = maxWidth / totalTextWidth;
        }

        let currentPos = (canvas.width - totalTextWidth * fontSizeMultiplier) / 2;

        // --- ç¬¬2æ®µéš: æº–å‚™ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦Canvasã«æç”»ã™ã‚‹ ---
        for (let i = 0; i < charData.length; i++) {
          const charInfo = charData[i];
          const adjustedWidth = charInfo.width * fontSizeMultiplier;

          if (charInfo.isSpace) {
            // ã‚¹ãƒšãƒ¼ã‚¹ã®å ´åˆã¯æç”»ã‚’å®Œå…¨ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã€ä½ç½®ã ã‘é€²ã‚ã‚‹
            currentPos += adjustedWidth + spacing * fontSizeMultiplier;
            continue; // æ¬¡ã®ãƒ«ãƒ¼ãƒ—ã¸é€²ã‚€
          }

          // é€šå¸¸ã®æ–‡å­—ã®æç”»
          const { char, font, size, bgWidth, bgColor, bgHeight } = charInfo;
          
          const adjustedFontSize = size * fontSizeMultiplier;
          ctx.font = `${font.weight} ${adjustedFontSize}px "${font.name}"`;
          const adjustedBgWidth = bgWidth * fontSizeMultiplier;
          const adjustedBgHeight = bgHeight * fontSizeMultiplier;
          
          // å„æ–‡å­—ã®æç”»ä½ç½®ã®ä¸­å¿ƒã‚’è¨ˆç®—
          const charCenterX = currentPos + adjustedBgWidth / 2;
          
          // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã¨å›è»¢è§’åº¦ã‚’ç”Ÿæˆ
          const randomRotation = (Math.random() - 0.5) * 0.8; // -0.4 ã‹ã‚‰ 0.4 ãƒ©ã‚¸ã‚¢ãƒ³ã«æ‹¡å¤§
          const randomYOffset = (Math.random() - 0.5) * 15; // -7.5 ã‹ã‚‰ 7.5 ãƒ”ã‚¯ã‚»ãƒ«ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã«æ‹¡å¤§

          ctx.save();
          
          // Canvasã®åŸç‚¹ã‚’æ–‡å­—ã®ä¸­å¿ƒã«ç§»å‹•
          ctx.translate(charCenterX, yPos + randomYOffset);
          
          // ãƒ©ãƒ³ãƒ€ãƒ ã«å›è»¢
          ctx.rotate(randomRotation);
          
          // èƒŒæ™¯ã‚’æç”»
          ctx.fillStyle = bgColor;
          const bgX = -adjustedBgWidth / 2;
          const bgY = -adjustedBgHeight / 2;
          ctx.fillRect(bgX, bgY, adjustedBgWidth, adjustedBgHeight);
          
          // æ–‡å­—ã‚’æç”»
          ctx.fillStyle = bgColor === '#000000' ? '#FFFFFF' : '#000000'; // èƒŒæ™¯ãŒé»’ãªã‚‰ç™½ã€ãã‚Œä»¥å¤–ã¯é»’
          // æ–‡å­—ã‚’å››è§’å½¢ã®ä¸­å¤®ã«é…ç½®
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(char, 0, 0);

          ctx.restore();
          
          // æ¬¡ã®æ–‡å­—ã®é–‹å§‹ä½ç½®ã‚’æ›´æ–°
          currentPos += adjustedBgWidth + spacing * fontSizeMultiplier;
        }
      };

      // Canvasã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
      const drawCanvas = () => {
        // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ³ãƒˆã®æ•°ã‚’ãƒã‚§ãƒƒã‚¯
        const selectedFonts = getSelectedFonts();
        if (selectedFonts.length < 2) {
          drawWarning("ãƒ•ã‚©ãƒ³ãƒˆã¯2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");
          return; // æç”»ã‚’ä¸­æ–­
        }
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯ã‚’å¡—ã‚Šã¤ã¶ã—
        ctx.fillStyle = '#fff8e1'; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯ã‚’ã‚¯ãƒªãƒ¼ãƒ è‰²ã«å¤‰æ›´
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ä¸Šæ®µã¨ä¸‹æ®µã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
        // æ–°ã—ã„èƒŒæ™¯è‰²ã‚’ç”Ÿæˆ
        if (!fixedColorsUpper) {
            fixedColorsUpper = upperTextInput.value.split('').map(() => getBackgroundColor());
        }
        if (!fixedColorsLower) {
            fixedColorsLower = lowerTextInput.value.split('').map((_, index) => {
                // ä¸Šæ®µã¨åŒã˜indexã®æ–‡å­—ã®è‰²ã‚’é¿ã‘ã‚‹
                return getBackgroundColor(fixedColorsUpper[index % fixedColorsUpper.length]);
            });
        }
        drawText(upperTextInput.value, canvas.height / 2 - 50, fixedColorsUpper);
        drawText(lowerTextInput.value, canvas.height / 2 + 50, fixedColorsLower);
      };

      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã¦Canvasã‚’å†æç”»
      upperTextInput.addEventListener('input', () => {
        // ãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰ã‚ã£ãŸã‚‰è‰²ã‚‚å†ç”Ÿæˆ
        fixedColorsUpper = null;
        fixedColorsLower = null;
        drawCanvas();
      });
      lowerTextInput.addEventListener('input', () => {
        // ãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰ã‚ã£ãŸã‚‰è‰²ã‚‚å†ç”Ÿæˆ
        fixedColorsUpper = null;
        fixedColorsLower = null;
        drawCanvas();
      });

      // åˆæœŸæç”»
      drawCanvas();

      // è¦‹ãŸç›®ã‚’å†ç”Ÿæˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      regenerateAppearanceButton.addEventListener('click', () => {
        // ãƒ•ã‚©ãƒ³ãƒˆã¨è‰²ã®ä¸¡æ–¹ã®æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†æç”»
        fixedColorsUpper = null;
        fixedColorsLower = null;
        drawCanvas();
      });

      // ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      saveButton.addEventListener('click', () => {
        const selectedFonts = getSelectedFonts();
        if (selectedFonts.length < 2) {
          drawWarning("ãƒ•ã‚©ãƒ³ãƒˆã¯2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");
          return; // æç”»ã‚’ä¸­æ–­
        }
        
        // ã¾ãšã€èƒŒæ™¯ã‚’é€æ˜ã«ã—ã¦æç”»
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawText(upperTextInput.value, canvas.height / 2 - 50, fixedColorsUpper);
        drawText(lowerTextInput.value, canvas.height / 2 + 50, fixedColorsLower);
        
        // PNGç”»åƒã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const imageURL = canvas.toDataURL('image/png');
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®èƒŒæ™¯ã‚’å…ƒã®è‰²ã«æˆ»ã™ (è¡¨ç¤ºç”¨)
        ctx.fillStyle = '#fff8e1';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawText(upperTextInput.value, canvas.height / 2 - 50, fixedColorsUpper);
        drawText(lowerTextInput.value, canvas.height / 2 + 50, fixedColorsLower);
        
        // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const link = document.createElement('a');
        link.href = imageURL;
        link.download = 'kaibunsho.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    });
  </script>
</body>
</html>